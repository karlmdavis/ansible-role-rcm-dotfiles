---
##
# Installs and verifies RCM on the container being used for the test case. 
##

- hosts: all
  tasks:
    - name: Authorize Test SSH Key
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"

    # The only differences between our test cases here are the variables, so we pull them from a separate include.
    - name: Set Ansible Variables for Test Case
      include_vars: "{{ lookup('env', 'TEST_VARS') }}.yml"
    
    - name: Apply Ansible Role
      import_role:
        name: karlmdavis.rcm-dotfiles

- hosts: all
  tasks:
    - name: Check for Files Created by Role
      stat:
        path: "{{ item }}"
      with_items:
        - "{{ lookup('env','HOME') }}/.dotfiles-karlmdavis.git"
      register: stat_rcm_files
    - name: Fail for Missing Files
      fail: msg='Missing file.'
      with_items: "{{ stat_rcm_files.results }}"
      when: item.stat.exists == false
